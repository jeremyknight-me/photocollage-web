@page "/libraries"
@using System.Collections.Concurrent

<h3>Photo Libraries</h3>

@code {
    private const string directory = "/data/collage";

    protected override Task OnInitializedAsync()
    {
        var files = Directory.EnumerateFiles(directory, "*", SearchOption.AllDirectories);
        var paths = this.GetPathsWithExtension(files);
        return base.OnInitializedAsync();
    }

    private IEnumerable<string> GetPathsWithExtension(IEnumerable<string> files)
    {
        var extensions = new HashSet<string> { ".jpg", ".jpeg", ".png" };
        var length = directory.Length;
        var paths = new ConcurrentQueue<string>();
        var exceptions = new ConcurrentQueue<Exception>();
        Parallel.ForEach(files, file =>
        {
            try
            {
                var fileExtension = Path.GetExtension(file);
                if (extensions.Contains(fileExtension, StringComparer.OrdinalIgnoreCase))
                {
                    var path = file.Remove(0, length).TrimStart(new[] { '\\' });
                    paths.Enqueue(path);
                }
            }
            catch (Exception ex)
            {
                exceptions.Enqueue(ex);
            }
        });

        return exceptions.IsEmpty
            ? paths
            : throw new AggregateException(exceptions);
    }
}
